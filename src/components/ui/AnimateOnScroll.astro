---
// src/components/ui/AnimateOnScroll.astro
// Pure CSS Animations with Minimal JS Trigger - Ultra Smooth
// Usage: <AnimateOnScroll animation="fade-up" delay={100}>content</AnimateOnScroll>

interface Props {
  animation?: 'fade-up' | 'fade-in' | 'fade-left' | 'fade-right' | 'scale-up' | 'slide-up' | 'slide-down' | 'zoom-in' | 'none';
  delay?: number;
  duration?: number;
  threshold?: number;
  once?: boolean;
  as?: 'div' | 'section' | 'article' | 'aside';
  class?: string;
  id?: string;
  [key: string]: any;
}

const {
  animation = 'fade-up',
  delay = 0,
  duration = 800,
  threshold = 0.1,
  once = true,
  as: Tag = 'div',
  class: className = '',
  id,
  ...rest
} = Astro.props;

// Generate unique ID if not provided
const elementId = id || `animate-${Math.random().toString(36).substr(2, 9)}`;
---

<Tag
  id={elementId}
  class={`animate-scroll ${className}`}
  data-animate={animation}
  data-delay={delay}
  data-duration={duration}
  data-threshold={threshold}
  data-once={once}
  style={`--delay: ${delay}ms; --duration: ${duration}ms`}
  {...rest}
>
  <slot />
</Tag>

<!-- Minimal JS - Only for trigger -->
<script>
  // Pure CSS Animation Trigger - Ultra Lightweight
  (() => {
    'use strict';

    // Respect reduced motion preference
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.querySelectorAll('.animate-scroll').forEach(el => {
        el.classList.add('animate-visible');
      });
      return;
    }

    // Minimal IntersectionObserver - only add/remove class
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate-visible');
            if (entry.target.dataset.once === 'true') {
              observer.unobserve(entry.target);
            }
          } else if (entry.target.dataset.once === 'false') {
            entry.target.classList.remove('animate-visible');
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      }
    );

    // Observe all animated elements
    document.querySelectorAll('.animate-scroll').forEach(el => {
      observer.observe(el);
    });

    // Re-init after Astro transitions
    document.addEventListener('astro:after-swap', () => {
      setTimeout(() => {
        document.querySelectorAll('.animate-scroll').forEach(el => {
          observer.observe(el);
        });
      }, 50);
    });
  })();
</script>

<style>
  /* Base State - Hidden */
  .animate-scroll {
    opacity: 0;
    will-change: opacity, transform;
    backface-visibility: hidden;
    -webkit-font-smoothing: antialiased;
    transform: translateZ(0);
  }

  /* Animation Definitions - Pure CSS Keyframes */

  /* Fade Up */
  @keyframes fade-up {
    from {
      opacity: 0;
      transform: translateY(40px) translateZ(0);
    }
    to {
      opacity: 1;
      transform: translateY(0) translateZ(0);
    }
  }

  /* Fade In */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.92) translateZ(0);
    }
    to {
      opacity: 1;
      transform: scale(1) translateZ(0);
    }
  }

  /* Fade Left */
  @keyframes fade-left {
    from {
      opacity: 0;
      transform: translateX(-40px) translateZ(0);
    }
    to {
      opacity: 1;
      transform: translateX(0) translateZ(0);
    }
  }

  /* Fade Right */
  @keyframes fade-right {
    from {
      opacity: 0;
      transform: translateX(40px) translateZ(0);
    }
    to {
      opacity: 1;
      transform: translateX(0) translateZ(0);
    }
  }

  /* Scale Up */
  @keyframes scale-up {
    from {
      opacity: 0;
      transform: scale(0.75) translateZ(0);
    }
    to {
      opacity: 1;
      transform: scale(1) translateZ(0);
    }
  }

  /* Slide Up */
  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px) translateZ(0);
    }
    to {
      opacity: 1;
      transform: translateY(0) translateZ(0);
    }
  }

  /* Slide Down */
  @keyframes slide-down {
    from {
      opacity: 0;
      transform: translateY(-20px) translateZ(0);
    }
    to {
      opacity: 1;
      transform: translateY(0) translateZ(0);
    }
  }

  /* Zoom In */
  @keyframes zoom-in {
    from {
      opacity: 0;
      transform: scale(0.5) translateZ(0);
    }
    to {
      opacity: 1;
      transform: scale(1) translateZ(0);
    }
  }

  /* Animation Application */
  .animate-scroll.animate-visible {
    animation-fill-mode: forwards;
    animation-timing-function: cubic-bezier(
      0.22,
      1,
      0.36,
      1
    ); /* Ultra smooth easing */
    animation-delay: var(--delay, 0ms);
    animation-duration: var(--duration, 800ms);
  }

  /* Map data-animate to specific animations */
  .animate-scroll[data-animate='fade-up'].animate-visible {
    animation-name: fade-up;
  }

  .animate-scroll[data-animate='fade-in'].animate-visible {
    animation-name: fade-in;
  }

  .animate-scroll[data-animate='fade-left'].animate-visible {
    animation-name: fade-left;
  }

  .animate-scroll[data-animate='fade-right'].animate-visible {
    animation-name: fade-right;
  }

  .animate-scroll[data-animate='scale-up'].animate-visible {
    animation-name: scale-up;
  }

  .animate-scroll[data-animate='slide-up'].animate-visible {
    animation-name: slide-up;
  }

  .animate-scroll[data-animate='slide-down'].animate-visible {
    animation-name: slide-down;
  }

  .animate-scroll[data-animate='zoom-in'].animate-visible {
    animation-name: zoom-in;
  }

  .animate-scroll[data-animate='none'].animate-visible {
    animation: none;
    opacity: 1;
  }

  /* After Animation Complete */
  .animate-scroll.animate-visible {
    /* Clean up will-change after animation */
    animation-iteration-count: 1;
  }

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    .animate-scroll {
      /* Smaller transform values for mobile */
    }

    .animate-scroll.animate-visible {
      /* Faster animations on mobile */
      animation-duration: calc(var(--duration, 800ms) * 0.85);
    }
  }

  /* Reduced Motion Support */
  @media (prefers-reduced-motion: reduce) {
    .animate-scroll,
    .animate-scroll.animate-visible {
      animation: none !important;
      opacity: 1 !important;
      transform: none !important;
      transition: opacity 0.3s ease !important;
    }
  }

  /* GPU Acceleration Hint */
  .animate-scroll {
    transform-style: preserve-3d;
  }
</style>
